<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Data Insight Explorer — GenAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{
      --bg:#090a1a; --panel:#0f1130; --panel-2:#0b0d26;
      --ink:#f2f3ff; --muted:#b3b6d6;
      --accent:#ffd056; --accent-2:#7bb2ff;
      --bad:#ff7e8d; --good:#79ffa9;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .app{max-width:1200px;margin:24px auto 80px;padding:0 16px}
    .header{display:flex;align-items:center;gap:12px;padding:16px 18px;background:linear-gradient(180deg,#1b1e55 0%,#0a0c22 85%);border:1px solid #2a2f73;border-radius:var(--radius);box-shadow:var(--shadow);position:sticky;top:12px;z-index:5}
    .badge{background:#181a46;border:1px solid #2e3483;padding:4px 10px;border-radius:999px;color:#d7d9ff}
    .pill{background:#16194a;border:1px solid #2a2f73;color:#e9eaff;padding:6px 12px;border-radius:999px;cursor:pointer}
    .button{background:linear-gradient(90deg,#3b43d6,#6e9bff);border:1px solid #6e9bff;color:#fff;padding:8px 14px;border-radius:10px;cursor:pointer}
    .button:disabled{opacity:.6;cursor:not-allowed}
    .card{background:radial-gradient(120% 140% at 80% -10%,#21246a 0%,#0b0d25 70%);border:1px solid #31357e;border-radius:var(--radius);padding:18px;margin-top:16px;box-shadow:var(--shadow)}
    .section-title{font-weight:800;letter-spacing:.2px;color:#fff;margin-bottom:8px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .chart{height:360px;width:100%;border:1px solid #2f3480;border-radius:12px;overflow:hidden;background:#0c0e2b}
    .narrative{white-space:pre-wrap;line-height:1.55}
    .hl{color:var(--accent)} .ok{color:var(--good)} .err{color:var(--bad)}
    .hstack{display:flex;align-items:center;gap:12px}

    /* nicer file input without changing markup */
    input[type="file"]{
      color:var(--muted);
      background:#12144a; border:1px solid #30368e; border-radius:10px; padding:6px 10px;
    }
    input[type="file"]::file-selector-button{
      margin-right:12px; padding:8px 12px; border:0; border-radius:8px;
      background:linear-gradient(90deg,#474fe3,#7aa8ff); color:#fff; cursor:pointer;
    }
    input[type="file"]::file-selector-button:hover{filter:brightness(1.1)}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div style="font-weight:800">⚡ Data Insight Explorer — <span class="hl">GenAI</span></div>
      <div style="flex:1"></div>
      <div id="whoami" class="badge">Checking API…</div>
      <button id="jump" class="pill" type="button" title="Scroll to narrative">Jump to Summary ⤵</button>
    </div>

    <div class="card">
      <div class="section-title">Upload & Analyze</div>
      <div class="hstack">
        <input id="file" type="file" accept=".csv,.xlsx"/>
        <button id="run" class="button">Analyze</button>
        <span id="fname" class="badge" style="display:none"></span>
        <span id="err" class="err"></span>
      </div>
      <div class="muted" style="margin-top:8px;">Backend: <code id="api">http://127.0.0.1:9999</code></div>
    </div>

    <!-- Results -->
    <div id="results" style="display:none">
      <!-- Insight & Executive Summary REMOVED by request -->

      <div id="cats"></div>

      <div class="card" id="reportCard" style="display:none">
        <div class="section-title">Report (stable figures)</div>
        <div id="report" class="grid"></div>
      </div>

      <div class="card" id="narrativeCard">
        <div class="section-title">Narrative Update</div>
        <div id="narrative" class="narrative"></div>
      </div>
    </div>
  </div>

<script>
  const BACKEND = "https://data-insight-api.onrender.com";
    // show the real URL in the little “Backend:” label
  const apiLabel = document.getElementById('api');
  if (apiLabel) apiLabel.textContent = BACKEND;

  // DOM
  const whoamiEl   = document.getElementById('whoami');
  const fileEl     = document.getElementById('file');
  const fnameEl    = document.getElementById('fname');
  const runBtn     = document.getElementById('run');
  const errEl      = document.getElementById('err');
  const resultsBox = document.getElementById('results');
  const catsEl     = document.getElementById('cats');
  const narrativeEl= document.getElementById('narrative');
  const reportGrid = document.getElementById('report');
  const reportCard = document.getElementById('reportCard');

  document.getElementById('jump').onclick = () => {
    document.getElementById('narrativeCard')?.scrollIntoView({behavior:'smooth', block:'start'});
  };

  fileEl.addEventListener('change', () => {
    const f = fileEl.files?.[0];
    fnameEl.style.display = f ? 'inline-block' : 'none';
    fnameEl.textContent = f ? f.name : '';
  });

  function h(tag, attrs={}, children=[]) {
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') el.className = v;
      else if (k === 'html') el.innerHTML = v;
      else el.setAttribute(k, v);
    }
    for (const c of [].concat(children)) if (c) el.appendChild(c);
    return el;
  }

  // Draw Plotly with brighter scheme + white axes
  function chart(container, fig) {
    const data   = Array.isArray(fig?.data) ? fig.data : [];
    const base   = fig?.layout || {};
    const axes   = {
      color:'#ffffff', tickcolor:'#ffffff',
      tickfont:{color:'#ffffff'},
      linecolor:'#ffffff', zerolinecolor:'#8aa0ff', gridcolor:'#2e3270'
    };
    const layout = Object.assign(
      {
        autosize:true,
        paper_bgcolor:'#0c0e2b',
        plot_bgcolor:'#0c0e2b',
        xaxis:Object.assign({titlefont:{color:'#ffffff'}}, base.xaxis||{}, axes),
        yaxis:Object.assign({titlefont:{color:'#ffffff'}}, base.yaxis||{}, axes),
        font:{color:'#eaeaff'}
      },
      base
    );
    const config = {displayModeBar:false, responsive:true};
    Plotly.newPlot(container, data, layout, config);
  }

  // whoami
  (async () => {
    try {
      const r = await fetch(`${BACKEND}/__whoami`);
      const j = await r.json();
      whoamiEl.textContent = j.ok ? `API v${j.version}` : 'Backend ?';
      whoamiEl.className = 'badge ' + (j.ok ? 'ok' : 'err');
    } catch {
      whoamiEl.textContent = 'API unreachable';
      whoamiEl.className = 'badge err';
    }
  })();

  // Analyze
  runBtn.addEventListener('click', async () => {
    errEl.textContent = '';
    const file = fileEl.files?.[0];
    if (!file) { errEl.textContent = 'Pick a CSV or XLSX first.'; return; }
    runBtn.disabled = true; runBtn.textContent = 'Analyzing…';

    try {
      const fd = new FormData(); fd.append('file', file, file.name);
      const r  = await fetch(`${BACKEND}/inspect_data`, { method:'POST', body: fd });
      const j  = await r.json();
      if (!r.ok || !j.ok) throw new Error(j?.detail || 'Server error');

      resultsBox.style.display = '';

      // ----- Categories rendering -----
      catsEl.innerHTML = '';
      const charts = j?.charts || {};

      for (const cat of (j?.analysis_kit?.categories || [])) {
        // KPIs: keep ONLY "Dataset Summary" one-liner
        if ((cat.name || '').toLowerCase().includes('kpi')) {
          const ds = (cat.tasks || []).find(t => (t.title || '').startsWith('Dataset Summary'));
          if (ds && ds.explanation) {
            const card = h('div', {class:'card'});
            card.appendChild(h('div', {class:'section-title', html:'KPIs'}));
            const box = h('div');
            box.appendChild(h('div', {style:'font-weight:700;margin-bottom:6px', html:'Dataset Summary'}));
            box.appendChild(h('div', {class:'muted', html: ds.explanation}));
            card.appendChild(box);
            catsEl.appendChild(card);
          }
          // Skip the rest of KPI tasks entirely
          continue;
        }

        // All other categories unchanged (plots + AI notes if present)
        const catCard = h('div', {class:'card'});
        catCard.appendChild(h('div', {class:'section-title', html:cat.name || 'Section'}));
        const grid = h('div', {class:'grid'});

        for (const t of (cat.tasks || [])) {
          const box = h('div');
          box.appendChild(h('div', {style:'font-weight:700', html: t.title || ''}));
          if (t.explanation) box.appendChild(h('div', {class:'muted', html: t.explanation}));
          if (t.chart_id && charts[t.chart_id]) {
            const div = h('div', {class:'chart'}); box.appendChild(div);
            setTimeout(() => chart(div, charts[t.chart_id]), 0);
          }
          if (t.ai?.summary) {
            const ai = h('div', {class:'card', html: t.ai.summary});
            ai.style.background = '#171a58'; ai.style.border='1px dashed #3e45c2';
            box.appendChild(ai);
          }
          grid.appendChild(box);
        }
        catCard.appendChild(grid);
        catsEl.appendChild(catCard);
      }

      // Stable figures if present
      reportGrid.innerHTML='';
      const stableKeys=['first_hist','corr_heatmap','first_scatter'];
      const any=stableKeys.some(k=>charts[k]); reportCard.style.display=any?'':'none';
      for(const k of stableKeys){
        if(!charts[k]) continue;
        const div=h('div',{class:'chart'}); reportGrid.appendChild(div);
        setTimeout(()=>chart(div,charts[k]),0);
      }

      // Narrative: show as returned (no “Good morning” injection here)
      const nar=(j?.closing_summary?.narrative||'').trim();
      narrativeEl.textContent = nar || '(No narrative returned.)';

      window.scrollTo({top:0,behavior:'smooth'});
    } catch(e) {
      errEl.textContent = e.message || String(e);
    } finally {
      runBtn.disabled=false; runBtn.textContent='Analyze';
    }
  });
</script>
</body>
</html>


